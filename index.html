<!DOCTYPE html>
<html>

<head>
  <title>Simple Roman Amphitheater Data Browser</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    #results {
      background-color: #f8f9fa;
    }

    #map {
      height: 40em;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark bg-dark">
    <span class="navbar-brand mb-0 p-4 h1">Simple Roman Amphitheater Data Browser</span>
    <span class="navbar-text p-4">Written as a test using ChatGPT and Bing Chat</span>
  </nav>

  <div class="container mt-4">
    <div class="row mt-4">
      <div class="col-lg-8">
        <div>Select from Menu:</div>
        <select id="idSelect" class="form-control"></select>
      </div>
    </div>

    <ul class="nav nav-tabs" id="tab-list" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-tab-content"
          type="button" role="tab" aria-controls="map-tab-content" aria-selected="true">Map</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-tab-content"
          type="button" role="tab" aria-controls="results-tab-content" aria-selected="false">About</button>
      </li>
    </ul>
    <div class="tab-content" id="tab-content">
      <div class="tab-pane fade show active" id="map-tab-content" role="tabpanel" aria-labelledby="map-tab">
        <div class="p-4" id="map"></div>
      </div>
      <div class="tab-pane fade" id="results-tab-content" role="tabpanel" aria-labelledby="results-tab">
        <div class="p-4" id="results"></div>
      </div>
    </div>

    <div>Code: <a
        href="https://github.com/roman-amphitheaters/browser">https://github.com/roman-amphitheaters/browser</a></div>
    <div>Data: <a
        href="http://github.com/roman-amphitheaters/roman-amphitheaters">http://github.com/roman-amphitheaters/roman-amphitheaters</a>
    </div>
    <div>Basemap: <a href="https://dh.gu.se/dare/">https://dh.gu.se/dare/</a></div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>

  <script>

    // Function to parse CSV data into an array of objects
    function parseCSV(csv) {
      const lines = csv.split('\n');
      const headers = lines[0].split(',');

      const result = [];
      for (let i = 1; i < lines.length; i++) {
        const obj = {};
        const currentLine = lines[i].split(',');

        for (let j = 0; j < headers.length; j++) {
          const value = currentLine[j] ? currentLine[j].replace(/['"]+/g, '').trim() : ''; // Remove quotes and trim value
          const key = headers[j].replace(/['"]+/g, '').trim(); // Remove quotes and trim key
          obj[key] = value;
        }

        result.push(obj);
      }

      return result;
    }

    // Function to populate the ID dropdown menu
    function populateIdDropdown() {
      const idSelect = document.getElementById('idSelect');

      data.sort((a, b) => {
        if (a.label < b.label) {
          return -1;
        } else if (a.label > b.label) {
          return 1;
        } else {
          return 0;
        }
      });

      data.forEach(item => {
        const option = document.createElement('option');
        const idValue = item.hasOwnProperty('id') ? item['id'] : ''; // Access the 'id' key correctly
        const labelValue = item.hasOwnProperty('label') ? item['label'] : ''; // Access the 'label' key correctly
        const mcValue = item.hasOwnProperty('modcountry') ? item['modcountry'] : '';
        option.value = idValue;
        option.textContent = `${labelValue} (${mcValue})`;
        idSelect.appendChild(option);
      });
    }

    // Function to display the selected row
    function displayRow() {
      const selectedId = idSelect.value;
      const selectedRow = data.find(item => item['id'] === selectedId); // Access the ID value correctly

      showResult(selectedRow);
    }

    // Function to display the selected row's columns and show a map
    function showResult(row) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!row) {
        resultsDiv.textContent = 'No results found.';
        return;
      }

      const idValue = row.hasOwnProperty('id') ? row['id'] : '';
      const rowItem = document.createElement('div');
      rowItem.textContent = `id: ${idValue}`;
      resultsDiv.appendChild(rowItem);

      for (const key in row) {
        if (Object.hasOwnProperty.call(row, key) && key !== 'id') {
          const value = row[key];
          const rowItem = document.createElement('div');
          rowItem.classList.add('row', 'mb-2');

          const keyCol = document.createElement('div');
          keyCol.classList.add('col-sm-3', 'font-weight-bold');
          keyCol.textContent = key;

          const valueCol = document.createElement('div');
          valueCol.classList.add('col-sm-9');

          // Check if the value is a URL
          if (value.includes('http://') || value.includes('https://')) {
            const link = document.createElement('a');
            link.href = value;
            link.textContent = value;
            valueCol.appendChild(link);
          } else {
            valueCol.textContent = value;
          }

          rowItem.appendChild(keyCol);
          rowItem.appendChild(valueCol);
          resultsDiv.appendChild(rowItem);
        }
      }
      const latitudeValue = row.hasOwnProperty('latitude') ? row['latitude'] : '';
      const longitudeValue = row.hasOwnProperty('longitude') ? row['longitude'] : '';

      if (map != undefined || map != null) {
        map.remove();
        map = undefined
        document.getElementById('map-tab-content').innerHTML = "<div id='map'></div>";
      }

      map = L.map('map').setView([latitudeValue, longitudeValue], 5);

      var dare = L.tileLayer('https://dh.gu.se/tiles/imperium/{z}/{x}/{y}.png', {
        attribution: 'Digital Atlas of the Roman Empire',
        maxZoom: 13,
      }).addTo(map);

      var esriSatellite = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        {
          attribution: 'Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP',
          maxZoom: 18,
        }
      );

      var Stamen_TerrainBackground = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}{r}.{ext}', {
        attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        subdomains: 'abcd',
        minZoom: 0,
        maxZoom: 18,
        ext: 'png'
      });

      // Create a tile layer using the OSM terrain tileset URL
      var osmTopoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
      });

      var baseMaps = {
        DARE: dare,
        'ESRI Satellite': esriSatellite,
        'Stamen Terrain': Stamen_TerrainBackground,
        'OSM Topo & Streets': osmTopoLayer
      };

      L.control.layers(baseMaps, null, { collapsed: false }).addTo(map); // Add the layers control to the map


      marker = L.marker([latitudeValue, longitudeValue]);

      marker.addTo(map);

      fetch('https://roman-amphitheaters.github.io/roman-amphitheaters/roman-amphitheaters.geojson')
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          L.geoJSON(data, {
            pointToLayer: function (feature, latlng) {
              return L.circleMarker(latlng, {
                radius: 4,
                fillColor: 'red',
                color: 'red',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
              });
            },
            onEachFeature: function (feature, layer) {
              if (feature.properties && feature.properties.label) {
                layer.bindTooltip(feature.properties.label);
              }
            }
          }).addTo(map);
        })
        .catch(function (error) {
          console.error('Error fetching GeoJSON:', error);
        });

    }

    // Load the CSV file from the relative URL
    fetch('roman-amphitheaters.csv')
      .then(response => response.text())
      .then(csvData => {
        data = parseCSV(csvData);
        populateIdDropdown(); // Populate the ID dropdown menu after CSV data is loaded
        // Set initial view. It would be nice if this worked... I'll figure it out. Shouldn't be hard
        idSelect.value = "romeFlavianAmphitheater";
        displayRow();

      })
      .catch(error => {
        console.error('Error loading CSV file:', error);
      });



    const mapTabButton = document.getElementById('map-tab');
    mapTabButton.addEventListener('shown.bs.tab', () => {
      map.invalidateSize();
    });

    // Add event listener for ID dropdown change
    const idSelect = document.getElementById('idSelect');
    idSelect.addEventListener('change', displayRow);
  </script>
</body>

</html>